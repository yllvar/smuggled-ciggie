<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaysia Illicit Cigarettes Study - Interactive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            background-color: #f8f9fa;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center">Malaysia Illicit Cigarettes Study</h1>
            <p class="text-center text-muted">Interactive Dashboard for Illicit Cigarette Trade Analysis</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Key Metrics -->
        <div class="row" id="key-metrics">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="total-consumption">-</div>
                    <div class="metric-label">Total Annual Consumption (Packs)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="illegal-share">-</div>
                    <div class="metric-label">Illegal Market Share</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="tax-loss">-</div>
                    <div class="metric-label">Annual Tax Revenue Loss (RM)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="illegal-value">-</div>
                    <div class="metric-label">Illegal Market Value (RM)</div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>State-Level Illegal Incidence</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="state-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Enforcement Scenarios ROI</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="roi-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Forecasted Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="forecast-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Tables -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Top 5 High-Risk States</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="high-risk-table">
                                <thead>
                                    <tr>
                                        <th>State</th>
                                        <th>Illegal Incidence (%)</th>
                                        <th>Estimated Loss (RM)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Enforcement Scenarios</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="scenarios-table">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>ROI (%)</th>
                                        <th>Market Reduction (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="row">
            <div class="col-md-12 text-center">
                <button class="btn btn-primary" id="reload-btn">Reload Data</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables for charts
        let stateChart, roiChart, forecastChart;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Set up reload button
            document.getElementById('reload-btn').addEventListener('click', function() {
                loadData();
            });
        });
        
        // Load all data
        function loadData() {
            loadStateData();
            loadForecastData();
            loadSimulationData();
        }
        
        // Load state data
        function loadStateData() {
            fetch('/api/state_data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateStateChart(data.data);
                        updateHighRiskTable(data.data);
                    } else {
                        console.error('Error loading state data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching state data:', error);
                });
        }
        
        // Load forecast data
        function loadForecastData() {
            fetch('/api/forecast_data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateForecastChart(data.data);
                    } else {
                        console.error('Error loading forecast data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching forecast data:', error);
                });
        }
        
        // Load simulation data
        function loadSimulationData() {
            fetch('/api/simulation_data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateKeyMetrics(data.data);
                        updateRoiChart(data.data);
                        updateScenariosTable(data.data);
                    } else {
                        console.error('Error loading simulation data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching simulation data:', error);
                });
        }
        
        // Update key metrics
        function updateKeyMetrics(data) {
            if (data.market_summary) {
                document.getElementById('total-consumption').textContent = 
                    formatNumber(data.market_summary.total_annual_packs);
                document.getElementById('illegal-share').textContent = 
                    data.market_summary.avg_illegal_incidence_pct.toFixed(1) + '%';
                document.getElementById('tax-loss').textContent = 
                    'RM ' + formatNumber(data.market_summary.tax_revenue_loss_rm);
                document.getElementById('illegal-value').textContent = 
                    'RM ' + formatNumber(data.market_summary.illegal_market_value_rm);
            }
        }
        
        // Update state chart
        function updateStateChart(data) {
            const states = [];
            const incidence = [];
            
            // Sort by illegal incidence and take top 10
            const sortedData = data
                .filter(row => row.State && row['Incidence of illegal cigarettes'])
                .sort((a, b) => b['Incidence of illegal cigarettes'] - a['Incidence of illegal cigarettes'])
                .slice(0, 10);
            
            sortedData.forEach(row => {
                states.push(row.State);
                incidence.push(row['Incidence of illegal cigarettes']);
            });
            
            const ctx = document.getElementById('state-chart').getContext('2d');
            
            if (stateChart) {
                stateChart.destroy();
            }
            
            stateChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states,
                    datasets: [{
                        label: 'Illegal Cigarette Incidence (%)',
                        data: incidence,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Update ROI chart
        function updateRoiChart(data) {
            if (!data.enforcement_scenarios || data.enforcement_scenarios.length === 0) {
                return;
            }
            
            const scenarios = [];
            const roi = [];
            
            data.enforcement_scenarios.forEach(scenario => {
                scenarios.push(scenario.scenario);
                roi.push(scenario.roi_pct);
            });
            
            const ctx = document.getElementById('roi-chart').getContext('2d');
            
            if (roiChart) {
                roiChart.destroy();
            }
            
            roiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scenarios,
                    datasets: [{
                        label: 'Return on Investment (%)',
                        data: roi,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update forecast chart
        function updateForecastChart(data) {
            if (!data.forecasts) {
                return;
            }
            
            const states = [];
            const current = [];
            const forecast = [];
            
            // Take first 5 states for visualization
            const stateEntries = Object.entries(data.forecasts).slice(0, 5);
            
            stateEntries.forEach(([state, values]) => {
                states.push(state);
                current.push(values.current);
                forecast.push(values.apr_2024);
            });
            
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            forecastChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states,
                    datasets: [
                        {
                            label: 'Current Incidence (%)',
                            data: current,
                            backgroundColor: 'rgba(13, 110, 253, 0.7)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Forecasted Incidence (%)',
                            data: forecast,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // Update high-risk table
        function updateHighRiskTable(data) {
            const tbody = document.querySelector('#high-risk-table tbody');
            tbody.innerHTML = '';
            
            // Sort by illegal incidence and take top 5
            const sortedData = data
                .filter(row => row.State && row['Incidence of illegal cigarettes'])
                .sort((a, b) => b['Incidence of illegal cigarettes'] - a['Incidence of illegal cigarettes'])
                .slice(0, 5);
            
            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.State}</td>
                    <td>${row['Incidence of illegal cigarettes'].toFixed(1)}%</td>
                    <td>RM ${formatNumber(row['Incidence of illegal cigarettes'] * 1000000)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Update scenarios table
        function updateScenariosTable(data) {
            if (!data.enforcement_scenarios || data.enforcement_scenarios.length === 0) {
                return;
            }
            
            const tbody = document.querySelector('#scenarios-table tbody');
            tbody.innerHTML = '';
            
            data.enforcement_scenarios.forEach(scenario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${scenario.scenario}</td>
                    <td>${scenario.roi_pct.toFixed(0)}%</td>
                    <td>${scenario.market_reduction_pct.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Format numbers with commas
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return num.toFixed(0);
            }
        }
    </script>
</body>
</html>
